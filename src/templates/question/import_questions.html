{% extends 'base.html' %}
{% block title %}استيراد أسئلة{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>استيراد أسئلة من ملف</h1>
    <p class="text-muted">قم برفع ملف Excel (.xlsx) أو CSV (.csv) يحتوي على الأسئلة لإضافتها إلى درس معين.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message | safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        <div class="mb-3">
            <label for="lesson_id" class="form-label">اختر الدرس *</label>
            <select class="form-select" id="lesson_id" name="lesson_id" required>
                <option value="" disabled selected>-- اختر درسًا --</option>
                {% set current_course = None %}
                {% set current_unit = None %}
                {% for lesson in lessons %}
                    {% if lesson.unit.course.name != current_course %}
                        {% if current_course is not none %}</optgroup>{% endif %}
                        {% if current_unit is not none %}</optgroup>{% endif %}
                        <optgroup label="{{ lesson.unit.course.name }}">
                        {% set current_course = lesson.unit.course.name %}
                        {% set current_unit = None %} {# Reset unit when course changes #}
                    {% endif %}
                    {% if lesson.unit.name != current_unit %}
                        {% if current_unit is not none %}</optgroup>{% endif %}
                        <optgroup label="&nbsp;&nbsp;&nbsp;{{ lesson.unit.name }}">
                        {% set current_unit = lesson.unit.name %}
                    {% endif %}
                    <option value="{{ lesson.id }}" {% if request.form.lesson_id == lesson.id|string %}selected{% endif %}>
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{{ lesson.name }}
                    </option>
                {% endfor %}
                {% if current_unit is not none %}</optgroup>{% endif %}
                {% if current_course is not none %}</optgroup>{% endif %}
            </select>
            <div class="invalid-feedback">
                الرجاء اختيار درس.
            </div>
        </div>

        <div class="mb-3">
            <label for="question_file" class="form-label">رفع ملف (.xlsx أو .csv) *</label>
            <input class="form-control" type="file" id="question_file" name="question_file" accept=".xlsx,.csv" required>
            <div class="invalid-feedback">
                الرجاء اختيار ملف بصيغة .xlsx أو .csv لرفعه.
            </div>
        </div>

        <div class="alert alert-info">
            <h5 class="alert-heading">متطلبات تنسيق الملف</h5>
            <p>يجب أن يحتوي الملف على الأعمدة التالية بالترتيب:</p>
            <ol>
                <li><code>نص السؤال</code> (اختياري في حال وجود صورة)</li>
                <li><code>رابط صورة السؤال</code> (اختياري)</li>
                <li><code>نص الخيار 1</code> (اختياري في حال وجود صورة)</li>
                <li><code>رابط صورة الخيار 1</code> (اختياري)</li>
                <li><code>نص الخيار 2</code> (اختياري في حال وجود صورة)</li>
                <li><code>رابط صورة الخيار 2</code> (اختياري)</li>
                <li><code>نص الخيار 3</code> (اختياري)</li>
                <li><code>رابط صورة الخيار 3</code> (اختياري)</li>
                <li><code>نص الخيار 4</code> (اختياري)</li>
                <li><code>رابط صورة الخيار 4</code> (اختياري)</li>
                <li><code>رقم الخيار الصحيح</code> (مطلوب: 1، 2، 3، أو 4)</li>
            </ol>
            <p><strong>هام:</strong></p>
            <ul>
                <li>يجب أن يحتوي الصف الأول على أسماء الأعمدة تمامًا كما هي مذكورة أعلاه.</li>
                <li>مطلوب خياران على الأقل (نص أو صورة) لكل سؤال.</li>
                <li>تأكد من أن روابط الصور صالحة ويمكن الوصول إليها بشكل عام.</li>
            </ul>
            <hr>
            <p><strong>تنزيل القالب:</strong>
                <a href="{{ url_for('question.download_template', format='xlsx') }}" class="btn btn-sm btn-outline-success">تنزيل قالب Excel (.xlsx)</a>
                <a href="{{ url_for('question.download_template', format='csv') }}" class="btn btn-sm btn-outline-secondary">تنزيل قالب CSV (.csv)</a>
            </p>
        </div>

        <button type="submit" class="btn btn-primary">استيراد الأسئلة</button>
        <a href="{{ url_for('question.list_questions') }}" class="btn btn-secondary">إلغاء</a>
    </form>

</div>

{# Add basic Bootstrap validation script #}
<script>
(function () {
  'use strict'
  var forms = document.querySelectorAll('.needs-validation')
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault()
          event.stopPropagation()
        }
        form.classList.add('was-validated')
      }, false)
    })
})()
</script>

{% endblock %}

