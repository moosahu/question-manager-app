{% extends "base.html" %}
{% block title %}استيراد أسئلة{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>استيراد أسئلة من ملف</h1>
    <p class="text-muted">قم برفع ملف Excel (.xlsx) أو CSV (.csv) يحتوي على الأسئلة لإضافتها إلى درس معين.</p>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
                    {{ message | safe }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <form method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
        {# Start: Cascading Dropdowns for Course, Unit, Lesson #}
        <div class="mb-3">
            <label for="course_id" class="form-label">الدورة <span class="text-danger">*</span></label>
            <select id="course_id" class="form-select" name="course_id_temp" required>
                <option value="" selected disabled>-- اختر الدورة --</option>
                {# Options will be populated by JavaScript #}
            </select>
            <div class="invalid-feedback">
                الرجاء اختيار الدورة.
            </div>
        </div>

        <div class="mb-3">
            <label for="unit_id" class="form-label">الوحدة <span class="text-danger">*</span></label>
            <select id="unit_id" class="form-select" name="unit_id_temp" required disabled>
                <option value="" selected disabled>-- اختر الوحدة --</option>
                {# Options will be populated by JavaScript #}
            </select>
            <div class="invalid-feedback">
                الرجاء اختيار الوحدة.
            </div>
        </div>

        <div class="mb-3">
            <label for="lesson_id" class="form-label">الدرس <span class="text-danger">*</span></label>
            <select name="lesson_id" id="lesson_id" class="form-select" required disabled>
                <option value="" selected disabled>-- اختر الدرس --</option>
                {# Options will be populated by JavaScript #}
            </select>
            <div class="invalid-feedback">
                الرجاء اختيار الدرس.
            </div>
        </div>
        {# End: Cascading Dropdowns #}

        <div class="mb-3">
            <label for="question_file" class="form-label">رفع ملف (.xlsx أو .csv) *</label>
            <input class="form-control" type="file" id="question_file" name="question_file" accept=".xlsx,.csv" required>
            <div class="invalid-feedback">
                الرجاء اختيار ملف بصيغة .xlsx أو .csv لرفعه.
            </div>
        </div>

        <div class="alert alert-info">
            <h5 class="alert-heading">متطلبات تنسيق الملف</h5>
            <p>يجب أن يحتوي الملف على الأعمدة التالية بالترتيب:</p>
            <ol>
                <li><code>نص السؤال</code> (اختياري في حال وجود صورة)</li>
                <li><code>رابط صورة السؤال</code> (اختياري)</li>
                <li><code>نص الخيار 1</code> (اختياري في حال وجود صورة)</li>
                <li><code>رابط صورة الخيار 1</code> (اختياري)</li>
                <li><code>نص الخيار 2</code> (اختياري في حال وجود صورة)</li>
                <li><code>رابط صورة الخيار 2</code> (اختياري)</li>
                <li><code>نص الخيار 3</code> (اختياري)</li>
                <li><code>رابط صورة الخيار 3</code> (اختياري)</li>
                <li><code>نص الخيار 4</code> (اختياري)</li>
                <li><code>رابط صورة الخيار 4</code> (اختياري)</li>
                <li><code>رقم الخيار الصحيح</code> (مطلوب: 1، 2، 3، أو 4)</li>
            </ol>
            <p><strong>هام:</strong></p>
            <ul>
                <li>يجب أن يحتوي الصف الأول على أسماء الأعمدة تمامًا كما هي مذكورة أعلاه.</li>
                <li>مطلوب خياران على الأقل (نص أو صورة) لكل سؤال.</li>
                <li>تأكد من أن روابط الصور صالحة ويمكن الوصول إليها بشكل عام.</li>
            </ul>
            <hr>
            <p><strong>تنزيل القالب:</strong>
                <a href="{{ url_for('question.download_template', format='xlsx') }}" class="btn btn-sm btn-outline-success">تنزيل قالب Excel (.xlsx)</a>
                <a href="{{ url_for('question.download_template', format='csv') }}" class="btn btn-sm btn-outline-secondary">تنزيل قالب CSV (.csv)</a>
            </p>
        </div>

        <button type="submit" class="btn btn-primary">استيراد الأسئلة</button>
        <a href="{{ url_for('question.list_questions') }}" class="btn btn-secondary">إلغاء</a>
    </form>

</div>
{% endblock %}

{% block scripts %}
<script>
(function () {
  'use strict';
  // Bootstrap validation
  var forms = document.querySelectorAll('.needs-validation');
  Array.prototype.slice.call(forms)
    .forEach(function (form) {
      form.addEventListener('submit', function (event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
        }
        form.classList.add('was-validated');
      }, false);
    });

    // Cascading dropdown logic
    const courseSelect = document.getElementById("course_id");
    const unitSelect = document.getElementById("unit_id");
    const lessonSelect = document.getElementById("lesson_id");

    // Check for a previously selected lesson_id (e.g., if form validation failed and page reloaded)
    const selectedLessonId = "{{ request.form.lesson_id if request.form.lesson_id else '' }}";
    let preselectCourseId = null;
    let preselectUnitId = null;

    function populateSelect(selectElement, items, placeholder, selectedValue = null) {
        selectElement.innerHTML = `<option value="" selected disabled>${placeholder}</option>`;
        items.forEach(item => {
            const option = document.createElement("option");
            option.value = item.id;
            option.textContent = item.name;
            if (selectedValue && item.id.toString() === selectedValue.toString()) {
                option.selected = true;
            }
            selectElement.appendChild(option);
        });
        selectElement.disabled = items.length === 0;
        if (items.length > 0) selectElement.disabled = false;
    }

    function clearAndDisableSelect(selectElement, placeholder) {
        selectElement.innerHTML = `<option value="" selected disabled>${placeholder}</option>`;
        selectElement.disabled = true;
    }

    async function fetchAndPopulateCourses() {
        try {
            const response = await fetch("{{ url_for('api.get_courses') }}");
            const data = await response.json();
            populateSelect(courseSelect, data, "-- اختر الدورة --", preselectCourseId);
            if (preselectCourseId) {
                courseSelect.dispatchEvent(new Event("change"));
            }
        } catch (error) {
            console.error("Error fetching courses:", error);
        }
    }

    courseSelect.addEventListener("change", async function() {
        const courseId = this.value;
        clearAndDisableSelect(unitSelect, "-- اختر الوحدة --");
        clearAndDisableSelect(lessonSelect, "-- اختر الدرس --");
        if (courseId) {
            try {
                const response = await fetch(`{{ url_for('api.get_units_for_course', course_id=0) }}${courseId}`.replace("0/",""));
                const data = await response.json();
                populateSelect(unitSelect, data, "-- اختر الوحدة --", preselectUnitId);
                if (preselectUnitId && unitSelect.value === preselectUnitId) {
                    unitSelect.dispatchEvent(new Event("change"));
                }
            } catch (error) {
                console.error("Error fetching units:", error);
            }
        }
    });

    unitSelect.addEventListener("change", async function() {
        const unitId = this.value;
        clearAndDisableSelect(lessonSelect, "-- اختر الدرس --");
        if (unitId) {
            try {
                const response = await fetch(`{{ url_for('api.get_lessons_for_unit', unit_id=0) }}${unitId}`.replace("0/",""));
                const data = await response.json();
                populateSelect(lessonSelect, data, "-- اختر الدرس --", selectedLessonId);
            } catch (error) {
                console.error("Error fetching lessons:", error);
            }
        }
    });

    // Function to fetch details if a lesson_id was previously selected (e.g. on form validation error reload)
    async function initializeDropdownsFromSelectedLesson() {
        if (selectedLessonId) {
            try {
                // We need to get the lesson's unit_id and the unit's course_id
                // This might require an additional API endpoint or modifying existing ones if not available
                // For now, let's assume we can get lesson details that include unit and course info
                // This is a placeholder for a more robust solution if lesson details aren't directly providing parent IDs
                // A simpler approach if the backend passes all courses, units, lessons on initial load (not the API way)
                // Given we use APIs, we need to fetch up the chain or have an endpoint for lesson details.

                // Ideal: fetch lesson details to get unit_id, then unit details for course_id
                // Simplified (if lesson object from a direct API call had parent IDs):
                // const lessonDetailsResponse = await fetch(`/api/v1/lessons/${selectedLessonId}`); // Hypothetical endpoint
                // const lessonDetails = await lessonDetailsResponse.json();
                // if (lessonDetails && lessonDetails.unit && lessonDetails.unit.course) {
                //     preselectCourseId = lessonDetails.unit.course.id;
                //     preselectUnitId = lessonDetails.unit.id;
                // }
                // As a workaround if the above is not available, we might have to iterate or make multiple calls.
                // For now, we'll just try to populate courses and let the chain reaction happen if IDs match.
                // This part needs careful implementation based on available API data for pre-selection.
                // The current `populateSelect` handles selecting the value if `preselectCourseId`, `preselectUnitId`, `selectedLessonId` are set.

                // For a robust pre-selection with dynamic API calls, you'd typically:
                // 1. Fetch all courses. If `selectedLessonId` exists, you'd need to find its course.
                // This is complex without knowing the full hierarchy beforehand or having an API to get a lesson's full path.

                // A pragmatic approach for now: if `request.form.lesson_id` is present, it means the form was submitted.
                // The backend should ideally also pass `request.form.course_id_temp` and `request.form.unit_id_temp` if they were part of the submission.
                // Let's assume for now that if `selectedLessonId` is present, the user will re-select.
                // A more complete solution would involve passing the selected course/unit IDs from the backend on form error.

                // Let's assume the backend would pass these if the form failed:
                preselectCourseId = "{{ request.form.course_id_temp if request.form.course_id_temp else '' }}";
                preselectUnitId = "{{ request.form.unit_id_temp if request.form.unit_id_temp else '' }}";

            } catch (error) {
                console.error("Error during pre-selection logic:", error);
            }
        }
        await fetchAndPopulateCourses(); // This will trigger the cascade if preselect IDs are set
    }

    initializeDropdownsFromSelectedLesson();

})();
</script>
{% endblock %}

