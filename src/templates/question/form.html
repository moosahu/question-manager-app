{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_extra %}
<style>
    /* تنسيق عام للصفحة */
    body {
        background-color: #f8f9fa;
    }
    
    /* تنسيق العنوان الرئيسي */
    .question-title {
        color: #8a6baf;
        font-size: 1.8rem;
        margin: 1.5rem 0;
        text-align: right;
    }
    
    /* تنسيق البطاقات */
    .card {
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        font-weight: 600;
    }
    
    /* تنسيق الحقول */
    .form-label {
        font-weight: 500;
    }
    
    .form-control, .form-select {
        border-radius: 6px;
    }
    
    /* تنسيق الخيارات */
    .option-group {
        border-radius: 8px;
    }
    
    .option-group.border-success {
        border-color: #28a745 !important;
    }
    
    /* تنسيق الأزرار */
    .btn-success {
        background-color: #28a745;
        border-color: #28a745;
    }
    
    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    .btn-primary {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    .btn-secondary {
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    /* تنسيق النجمة للحقول المطلوبة */
    .text-danger {
        color: #dc3545 !important;
    }
    
    /* تنسيق معاينة الصور */
    .img-thumbnail {
        border-radius: 4px;
    }
    
    /* تنسيق خاص بالجزيئات في الخلفية */
    .particles-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        overflow: hidden;
    }
    
    .particle {
        position: absolute;
        border-radius: 50%;
        opacity: 0.5;
    }
    
    .p1 { background-color: #8a6baf; width: 10px; height: 10px; top: 20%; left: 10%; }
    .p2 { background-color: #28a745; width: 15px; height: 15px; top: 30%; left: 20%; }
    .p3 { background-color: #17a2b8; width: 12px; height: 12px; top: 40%; left: 30%; }
    .p4 { background-color: #ffc107; width: 8px; height: 8px; top: 50%; left: 40%; }
    .p5 { background-color: #dc3545; width: 10px; height: 10px; top: 60%; left: 50%; }
    .p6 { background-color: #8a6baf; width: 14px; height: 14px; top: 70%; left: 60%; }
    .p7 { background-color: #28a745; width: 9px; height: 9px; top: 80%; left: 70%; }
    .p8 { background-color: #17a2b8; width: 11px; height: 11px; top: 90%; left: 80%; }
    .p9 { background-color: #ffc107; width: 13px; height: 13px; top: 25%; left: 85%; }
    .p10 { background-color: #dc3545; width: 7px; height: 7px; top: 75%; left: 15%; }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="question-title">{{ title }}</h1>

    <form method="post" enctype="multipart/form-data" id="question-form">
        <div class="row g-3">
            <div class="col-md-8">
                <div class="card mb-3">
                    <div class="card-header">تفاصيل السؤال</div>
                    <div class="card-body">
                        {# Start: Cascading Dropdowns for Course, Unit, Lesson #}
                        <div class="mb-3">
                            <label for="course_id" class="form-label">الدورة <span class="text-danger">*</span></label>
                            <select id="course_id" class="form-select" name="course_id_temp" required>
                                <option value="" selected disabled>-- اختر الدورة --</option>
                                {# Options will be populated by JavaScript #}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="unit_id" class="form-label">الوحدة <span class="text-danger">*</span></label>
                            <select id="unit_id" class="form-select" name="unit_id_temp" required disabled>
                                <option value="" selected disabled>-- اختر الوحدة --</option>
                                {# Options will be populated by JavaScript #}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="lesson_id" class="form-label">الدرس <span class="text-danger">*</span></label>
                            <select name="lesson_id" id="lesson_id" class="form-select" required disabled>
                                <option value="" selected disabled>-- اختر الدرس --</option>
                                {# Options will be populated by JavaScript #}
                            </select>
                        </div>
                        {# End: Cascading Dropdowns #}

                        <div class="mb-3">
                            <label for="text" class="form-label">نص السؤال (يدعم MathJax/ChemJax) <span class="text-danger">*</span></label>
                            <textarea name="text" id="text" rows="5" class="form-control mathjax-input">{{ question.question_text if question else request.form.get("text", "") }}</textarea>
                            <div class="form-text">استخدم $...$ أو \(...\) للمعادلات المضمنة، و $$...$$ أو \[...\] للمعادلات المنفصلة. مثال كيميائي: $\ce{H2O}$</div>
                            <div id="text-preview" class="mt-2 p-2 border bg-light" style="min-height: 50px;"></div>
                        </div>

                        <div class="mb-3">
                            <label for="question_image" class="form-label">صورة السؤال (اختياري)</label>
                            <input type="file" name="question_image" id="question_image" class="form-control image-input" accept="image/*" data-preview-target="question_image_preview">
                            <div class="mt-2 tex2jax_ignore">
                                {% if question and question.image_url %}
                                    {% if question.image_url.startswith('http') %}
                                        <img id="question_image_preview" src="{{ question.image_url }}" alt="معاينة صورة السؤال" style="max-width: 200px; max-height: 150px; display: block;" class="img-thumbnail mt-1">
                                    {% else %}
                                        <img id="question_image_preview" src="{{ url_for('static', filename=question.image_url) }}" alt="معاينة صورة السؤال" style="max-width: 200px; max-height: 150px; display: block;" class="img-thumbnail mt-1">
                                    {% endif %}
                                    <small class="d-block">الصورة الحالية</small>
                                    <div class="form-check mt-1">
                                        <input class="form-check-input" type="checkbox" name="delete_question_image" id="delete_question_image" value="1">
                                        <label class="form-check-label text-danger" for="delete_question_image">
                                            حذف الصورة الحالية
                                        </label>
                                    </div>
                                {% else %}
                                    <img id="question_image_preview" src="#" alt="معاينة صورة السؤال" style="max-width: 200px; max-height: 150px; display: none;" class="img-thumbnail mt-1">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card mb-3">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <span>الخيارات (خياران صالحان على الأقل، حدد الصحيح) <span class="text-danger">*</span></span>
                        <button type="button" class="btn btn-sm btn-success" id="add-option-btn">+ إضافة خيار</button>
                    </div>
                    <div class="card-body" id="options-container">
                        {# Container for dynamic options #}
                        {% set options = question.options if question else [] %}
                        {% if question %}
                            {% set initial_option_count = options|length if options|length > 1 else 2 %}
                        {% else %}
                            {% set initial_option_count = 4 %}
                        {% endif %}

                        {% for i in range(initial_option_count) %}
                        <div class="option-group border p-3 mb-3 rounded {% if i < options|length and options[i].is_correct %}border-success{% endif %}" data-index="{{ i }}">
                            <input type="hidden" name="option_id_{{ i }}" value="{{ options[i].option_id if i < options|length else "" }}">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h5 class="mb-0">الخيار <span class="option-number">{{ i+1 }}</span></h5>
                                <button type="button" class="btn btn-sm btn-danger remove-option-btn" {% if i < 2 %}disabled{% endif %}>&times; إزالة</button>
                            </div>
                            <div class="mb-3">
                                <label for="option_text_{{ i }}" class="form-label">نص الخيار (اختياري إذا وجدت صورة)</label>
                                <input type="text" name="option_text_{{ i }}" id="option_text_{{ i }}" class="form-control mathjax-input" value="{{ options[i].option_text if i < options|length else request.form.get('option_text_' ~ i, '') }}">
                                <div id="option_text_{{ i }}-preview" class="mt-2 p-2 border bg-light" style="min-height: 30px;"></div>
                            </div>
                            <div class="mb-3">
                                <label for="option_image_{{ i }}" class="form-label">صورة الخيار (اختياري)</label>
                                <input type="file" name="option_image_{{ i }}" id="option_image_{{ i }}" class="form-control image-input" accept="image/*" data-preview-target="option_image_{{ i }}_preview">
                                <div class="mt-2 tex2jax_ignore">
                                    {% if i < options|length and options[i].image_url %}
                                        {% if options[i].image_url.startswith('http') %}
                                            <img id="option_image_{{ i }}_preview" src="{{ options[i].image_url }}" alt="معاينة صورة الخيار {{ i+1 }}" style="max-width: 100px; max-height: 75px; display: block;" class="img-thumbnail mt-1">
                                        {% else %}
                                            <img id="option_image_{{ i }}_preview" src="{{ url_for('static', filename=options[i].image_url) }}" alt="معاينة صورة الخيار {{ i+1 }}" style="max-width: 100px; max-height: 75px; display: block;" class="img-thumbnail mt-1">
                                        {% endif %}
                                        <small class="d-block">الصورة الحالية</small>
                                        <div class="form-check mt-1">
                                            <input class="form-check-input" type="checkbox" name="delete_option_image_{{ i }}" id="delete_option_image_{{ i }}" value="1">
                                            <label class="form-check-label text-danger" for="delete_option_image_{{ i }}">
                                                حذف الصورة الحالية
                                            </label>
                                        </div>
                                    {% else %}
                                        <img id="option_image_{{ i }}_preview" src="#" alt="معاينة صورة الخيار {{ i+1 }}" style="max-width: 100px; max-height: 75px; display: none;" class="img-thumbnail mt-1">
                                    {% endif %}
                                </div>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input correct-option-radio" type="radio" name="correct_option" id="correct_option_{{ i }}" value="{{ i }}" {% if i < options|length and options[i].is_correct %}checked{% endif %} {% if i == 0 %}required{% endif %}>
                                <label class="form-check-label" for="correct_option_{{ i }}">
                                    هذا هو الخيار الصحيح
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header">الشرح (اختياري)</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="explanation" class="form-label">نص الشرح</label>
                            <textarea name="explanation" id="explanation" rows="4" class="form-control mathjax-input">{{ question.explanation if question else request.form.get("explanation", "") }}</textarea>
                            <div id="explanation-preview" class="mt-2 p-2 border bg-light" style="min-height: 40px;"></div>
                        </div>
                        <div class="mb-3">
                            <label for="explanation_image" class="form-label">صورة الشرح (اختياري)</label>
                            <input type="file" name="explanation_image" id="explanation_image" class="form-control image-input" accept="image/*" data-preview-target="explanation_image_preview">
                            <div class="mt-2 tex2jax_ignore">
                                {% if question and question.explanation_image_path %}
                                    {% if question.explanation_image_path.startswith('http') %}
                                        <img id="explanation_image_preview" src="{{ question.explanation_image_path }}" alt="معاينة صورة الشرح" style="max-width: 150px; max-height: 100px; display: block;" class="img-thumbnail mt-1">
                                    {% else %}
                                        <img id="explanation_image_preview" src="{{ url_for('static', filename=question.explanation_image_path) }}" alt="معاينة صورة الشرح" style="max-width: 150px; max-height: 100px; display: block;" class="img-thumbnail mt-1">
                                    {% endif %}
                                    <small class="d-block">الصورة الحالية</small>
                                    <div class="form-check mt-1">
                                        <input class="form-check-input" type="checkbox" name="delete_explanation_image" id="delete_explanation_image" value="1">
                                        <label class="form-check-label text-danger" for="delete_explanation_image">
                                            حذف الصورة الحالية
                                        </label>
                                    </div>
                                {% else %}
                                    <img id="explanation_image_preview" src="#" alt="معاينة صورة الشرح" style="max-width: 150px; max-height: 100px; display: none;" class="img-thumbnail mt-1">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-body tex2jax_ignore"> {# Ignore action links #}
                        <button type="submit" class="btn btn-primary w-100 mb-2">{{ submit_text }}</button>
                        <a href="{{ url_for("question.list_questions") }}" class="btn btn-secondary w-100">إلغاء</a>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Template for new option group (hidden) -->
    <div id="option-template" style="display: none;">
        <div class="option-group border p-3 mb-3 rounded" data-index="__INDEX__">
            <input type="hidden" name="option_id___INDEX__" value="">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h5 class="mb-0">الخيار <span class="option-number">__NUMBER__</span></h5>
                <button type="button" class="btn btn-sm btn-danger remove-option-btn">&times; إزالة</button>
            </div>
            <div class="mb-3">
                <label for="option_text___INDEX__" class="form-label">نص الخيار (اختياري إذا وجدت صورة)</label>
                <input type="text" name="option_text___INDEX__" id="option_text___INDEX__" class="form-control mathjax-input" value="">
                <div id="option_text___INDEX__-preview" class="mt-2 p-2 border bg-light" style="min-height: 30px;"></div>
            </div>
            <div class="mb-3">
                <label for="option_image___INDEX__" class="form-label">صورة الخيار (اختياري)</label>
                <input type="file" name="option_image___INDEX__" id="option_image___INDEX__" class="form-control image-input" accept="image/*" data-preview-target="option_image___INDEX___preview">
                <div class="mt-2 tex2jax_ignore">
                    <img id="option_image___INDEX___preview" src="#" alt="معاينة صورة الخيار __NUMBER__" style="max-width: 100px; max-height: 75px; display: none;" class="img-thumbnail mt-1">
                </div>
            </div>
            <div class="form-check">
                <input class="form-check-input correct-option-radio" type="radio" name="correct_option" id="correct_option___INDEX__" value="__INDEX__">
                <label class="form-check-label" for="correct_option___INDEX__">
                    هذا هو الخيار الصحيح
                </label>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const courseSelect = document.getElementById("course_id");
        const unitSelect = document.getElementById("unit_id");
        const lessonSelect = document.getElementById("lesson_id");

        // For pre-selection in edit mode
        const initialCourseId = "{{ question.lesson.unit.course_id if question and question.lesson and question.lesson.unit else "" }}";
        const initialUnitId = "{{ question.lesson.unit_id if question and question.lesson else "" }}";
        const initialLessonId = "{{ question.lesson_id if question else "" }}";

        function populateSelect(selectElement, items, placeholder, selectedValue = null) {
            selectElement.innerHTML = `<option value="" selected disabled>${placeholder}</option>`;
            items.forEach(item => {
                const option = document.createElement("option");
                option.value = item.id;
                option.textContent = item.name;
                if (selectedValue && item.id.toString() === selectedValue.toString()) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        }

        // تحميل الدورات عند تحميل الصفحة
        fetch('/api/v1/courses')
            .then(response => response.json())
            .then(data => {
                populateSelect(courseSelect, data.courses, "-- اختر الدورة --", initialCourseId);
                
                // إذا كان لدينا معرف دورة أولي، قم بتحميل وحداتها
                if (initialCourseId) {
                    fetch(`/api/v1/courses/${initialCourseId}/units`)
                        .then(response => response.json())
                        .then(data => {
                            populateSelect(unitSelect, data.units, "-- اختر الوحدة --", initialUnitId);
                            
                            // إذا كان لدينا معرف وحدة أولي، قم بتحميل دروسها
                            if (initialUnitId) {
                                fetch(`/api/v1/units/${initialUnitId}/lessons`)
                                    .then(response => response.json())
                                    .then(data => {
                                        populateSelect(lessonSelect, data.lessons, "-- اختر الدرس --", initialLessonId);
                                    });
                            }
                        });
                }
            });

        // حدث تغيير الدورة
        courseSelect.addEventListener("change", function() {
            const courseId = this.value;
            if (courseId) {
                // إعادة تعيين وتعطيل القوائم المنسدلة التابعة
                unitSelect.innerHTML = '<option value="" selected disabled>-- اختر الوحدة --</option>';
                lessonSelect.innerHTML = '<option value="" selected disabled>-- اختر الدرس --</option>';
                unitSelect.disabled = true;
                lessonSelect.disabled = true;
                
                // جلب الوحدات للدورة المحددة
                fetch(`/api/v1/courses/${courseId}/units`)
                    .then(response => response.json())
                    .then(data => {
                        populateSelect(unitSelect, data.units, "-- اختر الوحدة --");
                    });
            }
        });

        // حدث تغيير الوحدة
        unitSelect.addEventListener("change", function() {
            const unitId = this.value;
            if (unitId) {
                // إعادة تعيين وتعطيل قائمة الدروس
                lessonSelect.innerHTML = '<option value="" selected disabled>-- اختر الدرس --</option>';
                lessonSelect.disabled = true;
                
                // جلب الدروس للوحدة المحددة
                fetch(`/api/v1/units/${unitId}/lessons`)
                    .then(response => response.json())
                    .then(data => {
                        populateSelect(lessonSelect, data.lessons, "-- اختر الدرس --");
                    });
            }
        });

        // تحميل معاينات MathJax
        document.querySelectorAll('.mathjax-input').forEach(input => {
            const previewId = input.id + '-preview';
            const preview = document.getElementById(previewId);
            
            if (preview) {
                // Initial preview
                preview.innerHTML = input.value;
                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise([preview]);
                }
                
                // Update preview on input
                input.addEventListener('input', function() {
                    preview.innerHTML = this.value;
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([preview]);
                    }
                });
            }
        });

        // معالجة معاينة الصور
        document.querySelectorAll('.image-input').forEach(input => {
            input.addEventListener('change', function() {
                const previewId = this.dataset.previewTarget;
                const preview = document.getElementById(previewId);
                
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    }
                    
                    reader.readAsDataURL(this.files[0]);
                } else {
                    preview.src = '#';
                    preview.style.display = 'none';
                }
            });
        });

        // إضافة خيار جديد
        const addOptionBtn = document.getElementById('add-option-btn');
        const optionsContainer = document.getElementById('options-container');
        const optionTemplate = document.getElementById('option-template').innerHTML;
        
        addOptionBtn.addEventListener('click', function() {
            const optionGroups = optionsContainer.querySelectorAll('.option-group');
            const newIndex = optionGroups.length;
            const newNumber = newIndex + 1;
            
            let newOptionHtml = optionTemplate
                .replace(/__INDEX__/g, newIndex)
                .replace(/__NUMBER__/g, newNumber);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newOptionHtml;
            const newOption = tempDiv.firstElementChild;
            
            optionsContainer.appendChild(newOption);
            
            // تهيئة معاينة MathJax للخيار الجديد
            const newMathJaxInput = newOption.querySelector('.mathjax-input');
            if (newMathJaxInput) {
                const previewId = newMathJaxInput.id + '-preview';
                const preview = document.getElementById(previewId);
                
                if (preview) {
                    newMathJaxInput.addEventListener('input', function() {
                        preview.innerHTML = this.value;
                        if (typeof MathJax !== 'undefined') {
                            MathJax.typesetPromise([preview]);
                        }
                    });
                }
            }
            
            // تهيئة معاينة الصور للخيار الجديد
            const newImageInput = newOption.querySelector('.image-input');
            if (newImageInput) {
                newImageInput.addEventListener('change', function() {
                    const previewId = this.dataset.previewTarget;
                    const preview = document.getElementById(previewId);
                    
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        }
                        
                        reader.readAsDataURL(this.files[0]);
                    } else {
                        preview.src = '#';
                        preview.style.display = 'none';
                    }
                });
            }
            
            // إضافة وظيفة زر الإزالة
            const removeBtn = newOption.querySelector('.remove-option-btn');
            if (removeBtn) {
                removeBtn.addEventListener('click', function() {
                    newOption.remove();
                    updateOptionNumbers();
                });
            }
            
            // إضافة وظيفة الراديو بتن
            const radioBtn = newOption.querySelector('.correct-option-radio');
            if (radioBtn) {
                radioBtn.addEventListener('change', function() {
                    updateCorrectOptionHighlight();
                });
            }
        });
        
        // وظيفة زر إزالة الخيار
        document.querySelectorAll('.remove-option-btn').forEach(button => {
            button.addEventListener('click', function() {
                const optionGroup = this.closest('.option-group');
                optionGroup.remove();
                updateOptionNumbers();
            });
        });
        
        // تحديث أرقام الخيارات بعد الإزالة
        function updateOptionNumbers() {
            const optionGroups = optionsContainer.querySelectorAll('.option-group');
            optionGroups.forEach((group, index) => {
                group.querySelector('.option-number').textContent = index + 1;
                group.dataset.index = index;
                
                // تحديث قيمة الراديو بتن
                const radio = group.querySelector('.correct-option-radio');
                if (radio) {
                    radio.value = index;
                    radio.id = 'correct_option_' + index;
                    const label = group.querySelector('.form-check-label');
                    if (label) {
                        label.setAttribute('for', 'correct_option_' + index);
                    }
                }
            });
        }
        
        // تحديث تمييز الخيار الصحيح
        function updateCorrectOptionHighlight() {
            const optionGroups = optionsContainer.querySelectorAll('.option-group');
            optionGroups.forEach(group => {
                const radio = group.querySelector('.correct-option-radio');
                if (radio && radio.checked) {
                    group.classList.add('border-success');
                } else {
                    group.classList.remove('border-success');
                }
            });
        }
        
        // تهيئة تمييز الخيار الصحيح
        document.querySelectorAll('.correct-option-radio').forEach(radio => {
            radio.addEventListener('change', function() {
                updateCorrectOptionHighlight();
            });
        });
    });
</script>
{% endblock %}
