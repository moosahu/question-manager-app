{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_extra %}
<style>
    /* تنسيق عام للصفحة */
    .page-title {
        text-align: center;
        margin: 1.5rem 0;
        font-size: 1.8rem;
    }
    
    /* تنسيق البطاقات */
    .card {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 1.5rem;
    }
    
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1.25rem;
        font-weight: 500;
        text-align: right;
    }
    
    /* تنسيق الحقول */
    .form-label {
        margin-bottom: 0.5rem;
        font-weight: 500;
        text-align: right;
        display: block;
    }
    
    /* تنسيق النجمة للحقول المطلوبة */
    .text-danger {
        color: #dc3545 !important;
    }
    
    /* تنسيق معاينة الصور */
    .img-thumbnail {
        padding: 0.25rem;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        max-width: 100%;
        height: auto;
    }
    
    /* تنسيق خاص بالنموذج */
    .preview-area {
        min-height: 50px;
        border: 1px solid #dee2e6;
        background-color: #f8f9fa;
        padding: 0.5rem;
        margin-top: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <h1 class="page-title">{{ title }}</h1>
    
    <form method="post" enctype="multipart/form-data" id="question-form">
        <div class="row">
            <!-- العمود الأيسر: الشرح -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">الشرح (اختياري)</div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="explanation" class="form-label">نص الشرح</label>
                            <textarea name="explanation" id="explanation" rows="8" class="form-control mathjax-input">{{ question.explanation if question else request.form.get("explanation", "") }}</textarea>
                            <div id="explanation-preview" class="mt-2 p-2 border bg-light" style="min-height: 40px;"></div>
                        </div>
                        
                        <div class="mb-3">
                            <label for="explanation_image" class="form-label">صورة الشرح (اختياري)</label>
                            <input type="file" name="explanation_image" id="explanation_image" class="form-control image-input" accept="image/*" data-preview-target="explanation_image_preview">
                            <div class="mt-2 tex2jax_ignore">
                                {% if question and question.explanation_image_path %}
                                    {% if question.explanation_image_path.startswith('http') %}
                                        <img id="explanation_image_preview" src="{{ question.explanation_image_path }}" alt="معاينة صورة الشرح" style="max-width: 150px; max-height: 100px; display: block;" class="img-thumbnail mt-1">
                                    {% else %}
                                        <img id="explanation_image_preview" src="{{ url_for('static', filename=question.explanation_image_path) }}" alt="معاينة صورة الشرح" style="max-width: 150px; max-height: 100px; display: block;" class="img-thumbnail mt-1">
                                    {% endif %}
                                    <small class="d-block">الصورة الحالية</small>
                                    <div class="form-check mt-1">
                                        <input class="form-check-input" type="checkbox" name="delete_explanation_image" id="delete_explanation_image" value="1">
                                        <label class="form-check-label text-danger" for="delete_explanation_image">
                                            حذف الصورة الحالية
                                        </label>
                                    </div>
                                {% else %}
                                    <img id="explanation_image_preview" src="#" alt="معاينة صورة الشرح" style="max-width: 150px; max-height: 100px; display: none;" class="img-thumbnail mt-1">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary w-100 mb-2">{{ submit_text }}</button>
                    <a href="{{ url_for("question.list_questions") }}" class="btn btn-secondary w-100">إلغاء</a>
                </div>
            </div>
            
            <!-- العمود الأيمن: تفاصيل السؤال -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">تفاصيل السؤال</div>
                    <div class="card-body">
                        {# Start: Cascading Dropdowns for Course, Unit, Lesson #}
                        <div class="mb-3">
                            <label for="course_id" class="form-label">الدورة <span class="text-danger">*</span></label>
                            <select id="course_id" class="form-select" name="course_id_temp" required>
                                <option value="" selected disabled>-- اختر الدورة --</option>
                                {# Options will be populated by JavaScript #}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="unit_id" class="form-label">الوحدة <span class="text-danger">*</span></label>
                            <select id="unit_id" class="form-select" name="unit_id_temp" required disabled>
                                <option value="" selected disabled>-- اختر الوحدة --</option>
                                {# Options will be populated by JavaScript #}
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="lesson_id" class="form-label">الدرس <span class="text-danger">*</span></label>
                            <select name="lesson_id" id="lesson_id" class="form-select" required disabled>
                                <option value="" selected disabled>-- اختر الدرس --</option>
                                {# Options will be populated by JavaScript #}
                            </select>
                        </div>
                        {# End: Cascading Dropdowns #}

                        <div class="mb-3">
                            <label for="text" class="form-label">نص السؤال (يدعم MathJax/ChemJax) <span class="text-danger">*</span></label>
                            <textarea name="text" id="text" rows="5" class="form-control mathjax-input">{{ question.question_text if question else request.form.get("text", "") }}</textarea>
                            <div id="text-preview" class="mt-2 p-2 border bg-light" style="min-height: 50px;"></div>
                            <div class="form-text">استخدم $...$ أو \(...\) للمعادلات المضمنة، و $$...$$ أو \[...\] للمعادلات المنفصلة. مثال كيميائي: $\ce{H2O}$</div>
                        </div>

                        <div class="mb-3">
                            <label for="question_image" class="form-label">صورة السؤال (اختياري)</label>
                            <input type="file" name="question_image" id="question_image" class="form-control image-input" accept="image/*" data-preview-target="question_image_preview">
                            <div class="mt-2 tex2jax_ignore">
                                {% if question and question.image_url %}
                                    {% if question.image_url.startswith('http') %}
                                        <img id="question_image_preview" src="{{ question.image_url }}" alt="معاينة صورة السؤال" style="max-width: 200px; max-height: 150px; display: block;" class="img-thumbnail mt-1">
                                    {% else %}
                                        <img id="question_image_preview" src="{{ url_for('static', filename=question.image_url) }}" alt="معاينة صورة السؤال" style="max-width: 200px; max-height: 150px; display: block;" class="img-thumbnail mt-1">
                                    {% endif %}
                                    <small class="d-block">الصورة الحالية</small>
                                    <div class="form-check mt-1">
                                        <input class="form-check-input" type="checkbox" name="delete_question_image" id="delete_question_image" value="1">
                                        <label class="form-check-label text-danger" for="delete_question_image">
                                            حذف الصورة الحالية
                                        </label>
                                    </div>
                                {% else %}
                                    <img id="question_image_preview" src="#" alt="معاينة صورة السؤال" style="max-width: 200px; max-height: 150px; display: none;" class="img-thumbnail mt-1">
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- قسم الخيارات -->
        <div class="card mb-3">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>الخيارات (خياران صالحان على الأقل، حدد الصحيح) <span class="text-danger">*</span></span>
                <button type="button" class="btn btn-sm btn-success" id="add-option-btn">+ إضافة خيار</button>
            </div>
            <div class="card-body" id="options-container">
                {# Container for dynamic options #}
                {% set options = question.options if question else [] %}
                {% if question %}
                    {% set initial_option_count = options|length if options|length > 1 else 2 %}
                {% else %}
                    {% set initial_option_count = 4 %}
                {% endif %}

                {% for i in range(initial_option_count) %}
                <div class="option-group border p-3 mb-3 rounded {% if i < options|length and options[i].is_correct %}border-success{% endif %}" data-index="{{ i }}">
                    <input type="hidden" name="option_id_{{ i }}" value="{{ options[i].option_id if i < options|length else "" }}">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5 class="mb-0">الخيار <span class="option-number">{{ i+1 }}</span></h5>
                        <button type="button" class="btn btn-sm btn-danger remove-option-btn" {% if i < 2 %}disabled{% endif %}>&times; إزالة</button>
                    </div>
                    <div class="mb-3">
                        <label for="option_text_{{ i }}" class="form-label">نص الخيار (اختياري إذا وجدت صورة)</label>
                        <input type="text" name="option_text_{{ i }}" id="option_text_{{ i }}" class="form-control mathjax-input" value="{{ options[i].option_text if i < options|length else request.form.get('option_text_' ~ i, '') }}">
                        <div id="option_text_{{ i }}-preview" class="mt-2 p-2 border bg-light" style="min-height: 30px;"></div>
                    </div>
                    <div class="mb-3">
                        <label for="option_image_{{ i }}" class="form-label">صورة الخيار (اختياري)</label>
                        <input type="file" name="option_image_{{ i }}" id="option_image_{{ i }}" class="form-control image-input" accept="image/*" data-preview-target="option_image_{{ i }}_preview">
                        <div class="mt-2 tex2jax_ignore">
                            {% if i < options|length and options[i].image_url %}
                                {% if options[i].image_url.startswith('http') %}
                                    <img id="option_image_{{ i }}_preview" src="{{ options[i].image_url }}" alt="معاينة صورة الخيار {{ i+1 }}" style="max-width: 100px; max-height: 75px; display: block;" class="img-thumbnail mt-1">
                                {% else %}
                                    <img id="option_image_{{ i }}_preview" src="{{ url_for('static', filename=options[i].image_url) }}" alt="معاينة صورة الخيار {{ i+1 }}" style="max-width: 100px; max-height: 75px; display: block;" class="img-thumbnail mt-1">
                                {% endif %}
                                <small class="d-block">الصورة الحالية</small>
                                <div class="form-check mt-1">
                                    <input class="form-check-input" type="checkbox" name="delete_option_image_{{ i }}" id="delete_option_image_{{ i }}" value="1">
                                    <label class="form-check-label text-danger" for="delete_option_image_{{ i }}">
                                        حذف الصورة الحالية
                                    </label>
                                </div>
                            {% else %}
                                <img id="option_image_{{ i }}_preview" src="#" alt="معاينة صورة الخيار {{ i+1 }}" style="max-width: 100px; max-height: 75px; display: none;" class="img-thumbnail mt-1">
                            {% endif %}
                        </div>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input correct-option-radio" type="radio" name="correct_option" id="correct_option_{{ i }}" value="{{ i }}" {% if i < options|length and options[i].is_correct %}checked{% endif %} {% if i == 0 %}required{% endif %}>
                        <label class="form-check-label" for="correct_option_{{ i }}">
                            هذا هو الخيار الصحيح
                        </label>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </form>
</div>

<!-- Template for new option group (hidden) -->
<div id="option-template" style="display: none;">
    <div class="option-group border p-3 mb-3 rounded" data-index="__INDEX__">
        <input type="hidden" name="option_id___INDEX__" value="">
        <div class="d-flex justify-content-between align-items-center mb-2">
            <h5 class="mb-0">الخيار <span class="option-number">__NUMBER__</span></h5>
            <button type="button" class="btn btn-sm btn-danger remove-option-btn">&times; إزالة</button>
        </div>
        <div class="mb-3">
            <label for="option_text___INDEX__" class="form-label">نص الخيار (اختياري إذا وجدت صورة)</label>
            <input type="text" name="option_text___INDEX__" id="option_text___INDEX__" class="form-control mathjax-input" value="">
            <div id="option_text___INDEX__-preview" class="mt-2 p-2 border bg-light" style="min-height: 30px;"></div>
        </div>
        <div class="mb-3">
            <label for="option_image___INDEX__" class="form-label">صورة الخيار (اختياري)</label>
            <input type="file" name="option_image___INDEX__" id="option_image___INDEX__" class="form-control image-input" accept="image/*" data-preview-target="option_image___INDEX___preview">
            <div class="mt-2 tex2jax_ignore">
                <img id="option_image___INDEX___preview" src="#" alt="معاينة صورة الخيار __NUMBER__" style="max-width: 100px; max-height: 75px; display: none;" class="img-thumbnail mt-1">
            </div>
        </div>
        <div class="form-check">
            <input class="form-check-input correct-option-radio" type="radio" name="correct_option" id="correct_option___INDEX__" value="__INDEX__">
            <label class="form-check-label" for="correct_option___INDEX__">
                هذا هو الخيار الصحيح
            </label>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        const courseSelect = document.getElementById("course_id");
        const unitSelect = document.getElementById("unit_id");
        const lessonSelect = document.getElementById("lesson_id");

        // For pre-selection in edit mode
        const initialCourseId = "{{ question.lesson.unit.course_id if question and question.lesson and question.lesson.unit else "" }}";
        const initialUnitId = "{{ question.lesson.unit_id if question and question.lesson else "" }}";
        const initialLessonId = "{{ question.lesson_id if question else "" }}";

        function populateSelect(selectElement, items, placeholder, selectedValue = null) {
            selectElement.innerHTML = `<option value="" selected disabled>${placeholder}</option>`;
            items.forEach(item => {
                const option = document.createElement("option");
                option.value = item.id;
                option.textContent = item.name;
                if (selectedValue && item.id.toString() === selectedValue.toString()) {
                    option.selected = true;
                }
                selectElement.appendChild(option);
            });
            selectElement.disabled = false;
        }

        // Fetch courses
        fetch("/api/courses")
            .then(response => response.json())
            .then(data => {
                populateSelect(courseSelect, data, "-- اختر الدورة --", initialCourseId);
                
                // If we have an initial course ID, fetch its units
                if (initialCourseId) {
                    return fetch(`/api/courses/${initialCourseId}/units`);
                }
            })
            .then(response => response ? response.json() : null)
            .then(data => {
                if (data) {
                    populateSelect(unitSelect, data, "-- اختر الوحدة --", initialUnitId);
                    
                    // If we have an initial unit ID, fetch its lessons
                    if (initialUnitId) {
                        return fetch(`/api/units/${initialUnitId}/lessons`);
                    }
                }
            })
            .then(response => response ? response.json() : null)
            .then(data => {
                if (data) {
                    populateSelect(lessonSelect, data, "-- اختر الدرس --", initialLessonId);
                }
            })
            .catch(error => console.error("Error fetching data:", error));

        // Course change event
        courseSelect.addEventListener("change", function() {
            const courseId = this.value;
            unitSelect.innerHTML = '<option value="" selected disabled>-- اختر الوحدة --</option>';
            unitSelect.disabled = true;
            lessonSelect.innerHTML = '<option value="" selected disabled>-- اختر الدرس --</option>';
            lessonSelect.disabled = true;
            
            if (courseId) {
                fetch(`/api/courses/${courseId}/units`)
                    .then(response => response.json())
                    .then(data => {
                        populateSelect(unitSelect, data, "-- اختر الوحدة --");
                    })
                    .catch(error => console.error("Error fetching units:", error));
            }
        });

        // Unit change event
        unitSelect.addEventListener("change", function() {
            const unitId = this.value;
            lessonSelect.innerHTML = '<option value="" selected disabled>-- اختر الدرس --</option>';
            lessonSelect.disabled = true;
            
            if (unitId) {
                fetch(`/api/units/${unitId}/lessons`)
                    .then(response => response.json())
                    .then(data => {
                        populateSelect(lessonSelect, data, "-- اختر الدرس --");
                    })
                    .catch(error => console.error("Error fetching lessons:", error));
            }
        });

        // Handle form submission
        document.getElementById("question-form").addEventListener("submit", function(e) {
            // Copy the selected lesson_id to a hidden input
            const lessonId = lessonSelect.value;
            if (!lessonId) {
                e.preventDefault();
                alert("الرجاء اختيار الدرس");
                return;
            }
            
            // Create hidden input for lesson_id if it doesn't exist
            let hiddenInput = document.querySelector('input[name="lesson_id"]');
            if (!hiddenInput) {
                hiddenInput = document.createElement("input");
                hiddenInput.type = "hidden";
                hiddenInput.name = "lesson_id";
                this.appendChild(hiddenInput);
            }
            hiddenInput.value = lessonId;
        });

        // Image preview functionality
        document.querySelectorAll('.image-input').forEach(input => {
            input.addEventListener('change', function() {
                const previewId = this.getAttribute('data-preview-target');
                const preview = document.getElementById(previewId);
                
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        preview.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(this.files[0]);
                } else {
                    preview.src = '#';
                    preview.style.display = 'none';
                }
            });
        });

        // MathJax preview functionality
        document.querySelectorAll('.mathjax-input').forEach(input => {
            const previewId = input.id + '-preview';
            const preview = document.getElementById(previewId);
            
            if (preview) {
                // Initial preview
                preview.textContent = input.value || input.textContent;
                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise([preview]);
                }
                
                // Update preview on input
                input.addEventListener('input', function() {
                    preview.textContent = this.value || this.textContent;
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([preview]);
                    }
                });
            }
        });

        // Options management
        const optionsContainer = document.getElementById('options-container');
        const optionTemplate = document.getElementById('option-template').innerHTML;
        let optionCount = document.querySelectorAll('.option-group').length;

        // Add option button
        document.getElementById('add-option-btn').addEventListener('click', function() {
            const newOptionHtml = optionTemplate
                .replace(/__INDEX__/g, optionCount)
                .replace(/__NUMBER__/g, optionCount + 1);
            
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newOptionHtml;
            const newOption = tempDiv.firstElementChild;
            
            optionsContainer.appendChild(newOption);
            
            // Setup MathJax preview for new option
            const newInput = newOption.querySelector('.mathjax-input');
            if (newInput) {
                const previewId = newInput.id + '-preview';
                const preview = document.getElementById(previewId);
                
                if (preview) {
                    newInput.addEventListener('input', function() {
                        preview.textContent = this.value;
                        if (typeof MathJax !== 'undefined') {
                            MathJax.typesetPromise([preview]);
                        }
                    });
                }
            }
            
            // Setup image preview for new option
            const newImageInput = newOption.querySelector('.image-input');
            if (newImageInput) {
                newImageInput.addEventListener('change', function() {
                    const previewId = this.getAttribute('data-preview-target');
                    const preview = document.getElementById(previewId);
                    
                    if (this.files && this.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            preview.style.display = 'block';
                        };
                        reader.readAsDataURL(this.files[0]);
                    } else {
                        preview.src = '#';
                        preview.style.display = 'none';
                    }
                });
            }
            
            optionCount++;
            updateOptionNumbers();
        });

        // Remove option button
        optionsContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-option-btn') && !e.target.disabled) {
                const optionGroup = e.target.closest('.option-group');
                optionGroup.remove();
                updateOptionNumbers();
            }
        });

        // Update option numbers
        function updateOptionNumbers() {
            const options = document.querySelectorAll('.option-group');
            options.forEach((option, index) => {
                option.querySelector('.option-number').textContent = index + 1;
                option.dataset.index = index;
                
                // Update the value of the radio button
                const radio = option.querySelector('.correct-option-radio');
                radio.value = index;
                radio.id = `correct_option_${index}`;
                option.querySelector('label[for^="correct_option_"]').setAttribute('for', `correct_option_${index}`);
                
                // Disable remove button for first two options
                const removeBtn = option.querySelector('.remove-option-btn');
                removeBtn.disabled = index < 2;
            });
        }
    });
</script>
{% endblock %}
